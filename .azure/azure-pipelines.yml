trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: neighborly-test-credentials

stages:
  - stage: Deploy
    displayName: 'Deploy Application'
    jobs:
      - job: DeployJob
        displayName: 'Deploy to Environment'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'

          - script: echo "Deployment steps here"
            displayName: 'Deploy Application'

  - stage: PerformanceTest
    displayName: 'Performance Tests'
    dependsOn: Deploy
    jobs:
      - job: SmokeTest
        displayName: 'Performance Smoke Test'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'

          - script: |
              cd performance
              npm install
            displayName: 'Install Dependencies'

          - script: |
              cd performance
              npm run test:smoke:cloud
            displayName: 'Run Performance Smoke Test'
            env:
              ADMIN_EMAIL: $(ADMIN_EMAIL)
              ADMIN_PASSWORD: $(ADMIN_PASSWORD)
              ARTILLERY_CLOUD_API_KEY: $(ARTILLERY_CLOUD_API_KEY)

  - stage: E2ETests
    displayName: 'E2E Tests'
    dependsOn: PerformanceTest
    jobs:
      - job: APITests
        displayName: 'API Tests'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'

          - script: |
              cd e2e_api
              npm install
            displayName: 'Install API Test Dependencies'

          - script: |
              cd e2e_api
              npm run test:api
            displayName: 'Run API Tests'
            env:
              TEST_USER_EMAIL: $(TEST_USER_EMAIL)
              TEST_USER_PASSWORD: $(TEST_USER_PASSWORD)
              SUPABASE_API_KEY: $(SUPABASE_API_KEY)

      - job: UITests
        displayName: 'UI Tests'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'

          - script: |
              cd e2e_ui
              npm install
              npx playwright install --with-deps
            displayName: 'Install UI Test Dependencies'

          - script: |
              cd e2e_ui
              npm run test:ui
            displayName: 'Run UI Tests'
            env:
              BASE_URL: $(BASE_URL)
              STAFF_EMAIL: $(STAFF_EMAIL)
              STAFF_PASSWORD: $(STAFF_PASSWORD)
              APPLICANT_EMAIL: $(APPLICANT_EMAIL)
              APPLICANT_PASSWORD: $(APPLICANT_PASSWORD)
              ADMIN_EMAIL: $(ADMIN_EMAIL)
              ADMIN_PASSWORD: $(ADMIN_PASSWORD)
              CI: true

          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/*.xml'
              testRunTitle: 'UI Test Results'
            displayName: 'Publish UI Test Results'

          - task: PublishPipelineArtifact@1
            condition: failed()
            inputs:
              targetPath: 'e2e_ui/playwright-report'
              artifact: 'playwright-report'
              publishLocation: 'pipeline'
            displayName: 'Publish Playwright Report'

  - stage: FullLoadTest
    displayName: 'Full Load Test'
    dependsOn: E2ETests
    condition: succeeded()
    jobs:
      - job: LoadTest
        displayName: 'Full Performance Load Test'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'

          - script: |
              cd performance
              npm install
            displayName: 'Install Dependencies'

          - script: |
              cd performance
              npm run test:cloud
            displayName: 'Run Full Load Test'
            env:
              ADMIN_EMAIL: $(ADMIN_EMAIL)
              ADMIN_PASSWORD: $(ADMIN_PASSWORD)
              ARTILLERY_CLOUD_API_KEY: $(ARTILLERY_CLOUD_API_KEY)
